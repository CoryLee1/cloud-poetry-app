<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta charset="utf-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <link rel="stylesheet" href="style.css" />
    <script src="api-services.js"></script>
    <!-- p5.js åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <!-- è¯—æ­Œè½ä¸‹æ•ˆæœè„šæœ¬ -->
    <script src="falling-words.js"></script>
    
    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgMusic" loop>
        <source src="bgm/yeule vv.mp3" type="audio/mpeg">
    </audio>
  </head>
  <body>
    <div class="screen" data-model-id="43:3828">
      <div class="overlap-wrapper">
        <div class="overlap">
          <!-- Three.js Canvas æœ€åº•å±‚èƒŒæ™¯ -->
          <canvas id="three-canvas" class="cloud-layer"></canvas>
          
          <!-- UIå±‚ - åœ¨Three.jsä¹‹ä¸Š -->
          <img class="vector" src="img/vector-3212.svg" />
          <img class="img" src="img/vector-3213.svg" />
          <div class="home-indicator"><div class="div"></div></div>
          <div class="frame">
            <div class="frame-2">
              <div class="HI-IVY">HI~</div>
              <div class="text-wrapper">ä»Šå¤©å¿ƒæƒ…æ€ä¹ˆæ ·?</div>
            </div>
            <div class="element">
              ä½ æ¥å•¦! ä»Šå¤©æƒ³å’Œæˆ‘è¯´ä»€ä¹ˆå‘¢?<br />å“¦å¯¹äº†!ä»Šå¤©ä¸Šæµ·çš„å¤ªé˜³è½ä¸‹æ—¶é—´æ˜¯18:34åˆ†<br />å¯ä»¥æ”¾ä¸‹ç¹ç,æŠ½ç‚¹æ—¶é—´çœ‹çœ‹å¤•é˜³~
            </div>
          </div>
          <div class="frame-3">
            <div class="status-bar">
              <div class="left-side">
                <div class="statusbar-time"><div class="time">9:41</div></div>
              </div>
              <div class="dynamic-island">
                <div class="statusbar">
                  <div class="truedepth-camera"></div>
                  <div class="facetime-camera"></div>
                </div>
              </div>
              <div class="right-side">
                <div class="signal-wifi-battery">
                  <img class="icon-mobile-signal" src="img/icon-mobile-signal.svg" />
                  <img class="wifi" src="img/wifi.svg" />
                  <img class="statusbar-battery" src="img/statusbar-battery.svg" />
                </div>
              </div>
            </div>
            <div class="frame-4">
              <div class="frame-5">
                <img class="vector-2" src="img/vector.svg" /> <img class="vector-3" src="img/vector-1.svg" />
              </div>
              <div class="element-2">7æœˆ21æ—¥&nbsp;&nbsp;ï½œ ä¸Šæµ· å°é›¨</div>
              <div class="frame-5">
                <div class="overlap-group">
                  <div class="rectangle"></div>
                  <img class="vector-4" src="img/vector-13.svg" />
                  <img class="vector-5" src="img/vector-15.svg" />
                  <img class="vector-6" src="img/vector-15.svg" />
                  <img class="vector-7" src="img/vector-13.svg" />
                </div>
              </div>
            </div>
          </div>
          <div class="frame-6">
            <div class="frame-7">
              <input 
                type="text" 
                class="text-wrapper-2 input-field" 
                placeholder="ç°åœ¨çš„ä½ ï¼Œæ˜¯ä»€ä¹ˆæ„Ÿè§‰å‘¢ï¼Ÿ" 
                value=""
              />
            </div>
            <div class="view">
              <img class="vector-8" src="img/vector-2.svg" />
              <img class="vector-9" src="img/vector-3.svg" />
              <img class="vector-10" src="img/vector-4.svg" />
              <img class="vector-11" src="img/vector-5.svg" />
            </div>
          </div>
          
        </div>
      </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "./src/utils/build/three.module.js",
                "three/addons/": "./src/utils/jsm/"
            }
        }
    </script>

    <script type="module">
        import cloudScene from './three-scene.js';

        // åˆå§‹åŒ–Three.jsåœºæ™¯
        cloudScene.init();

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´
        window.addEventListener('resize', () => {
            cloudScene.resize();
        });

        // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
        const bgMusic = document.getElementById('bgMusic');
        let isMusicStarted = false;

        // å¤šç§æ–¹å¼è§¦å‘éŸ³ä¹æ’­æ”¾
        function initBackgroundMusic() {
            // 1. é¡µé¢åŠ è½½å®Œæˆåå°è¯•æ’­æ”¾
            window.addEventListener('load', () => {
                startBackgroundMusic();
            });

            // 2. ç”¨æˆ·äº¤äº’åæ’­æ”¾ï¼ˆè§£å†³æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
            const interactionEvents = ['click', 'touchstart', 'keydown', 'mousedown'];
            interactionEvents.forEach(event => {
                document.addEventListener(event, () => {
                    if (!isMusicStarted) {
                        startBackgroundMusic();
                    }
                }, { once: true }); // åªè§¦å‘ä¸€æ¬¡
            });

            // 3. é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ’­æ”¾
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && !isMusicStarted) {
                    startBackgroundMusic();
                }
            });

            // 4. å»¶è¿Ÿå°è¯•æ’­æ”¾
            setTimeout(() => {
                if (!isMusicStarted) {
                    startBackgroundMusic();
                }
            }, 2000);
        }

        // å¼€å§‹èƒŒæ™¯éŸ³ä¹
        function startBackgroundMusic() {
            if (isMusicStarted) return;
            
            bgMusic.volume = 0; // åˆå§‹éŸ³é‡ä¸º0
            bgMusic.play().then(() => {
                isMusicStarted = true;
                console.log('èƒŒæ™¯éŸ³ä¹å¼€å§‹æ’­æ”¾');
                // æ¸å…¥æ•ˆæœ
                fadeInMusic();
            }).catch(error => {
                console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’:', error);
                // å¦‚æœå¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’
                document.addEventListener('click', () => {
                    if (!isMusicStarted) {
                        bgMusic.play().then(() => {
                            isMusicStarted = true;
                            console.log('ç”¨æˆ·äº¤äº’åéŸ³ä¹å¼€å§‹æ’­æ”¾');
                            fadeInMusic();
                        });
                    }
                }, { once: true });
            });
        }

        // éŸ³ä¹æ¸å…¥æ•ˆæœ
        function fadeInMusic() {
            let volume = 0;
            const targetVolume = 0.3; // ç›®æ ‡éŸ³é‡
            const fadeDuration = 3000; // æ¸å…¥æ—¶é—´3ç§’
            const fadeStep = targetVolume / (fadeDuration / 50); // æ¯50mså¢åŠ ä¸€æ¬¡éŸ³é‡
            
            const fadeInterval = setInterval(() => {
                volume += fadeStep;
                if (volume >= targetVolume) {
                    volume = targetVolume;
                    clearInterval(fadeInterval);
                }
                bgMusic.volume = volume;
            }, 50);
        }

        // åˆå§‹åŒ–éŸ³ä¹
        initBackgroundMusic();

        // éŸ³ä¹çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateMusicStatus() {
            const musicStatus = document.createElement('div');
            musicStatus.id = 'musicStatus';
            musicStatus.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 12px;
                z-index: 1000;
                opacity: 0.8;
            `;
            musicStatus.textContent = isMusicStarted ? 'ğŸµ éŸ³ä¹æ’­æ”¾ä¸­' : 'ğŸ”‡ ç­‰å¾…æ’­æ”¾';
            document.body.appendChild(musicStatus);

            // 3ç§’åéšè—çŠ¶æ€æŒ‡ç¤ºå™¨
            setTimeout(() => {
                if (musicStatus.parentNode) {
                    musicStatus.remove();
                }
            }, 3000);
        }

        // é¡µé¢åŠ è½½åæ˜¾ç¤ºéŸ³ä¹çŠ¶æ€
        window.addEventListener('load', () => {
            setTimeout(updateMusicStatus, 1000);
        });
    </script>

    <!-- APIäº¤äº’è„šæœ¬ -->
    <script>
        // è·å–å…ƒç´ 
        const inputField = document.querySelector('.input-field');
        const voiceButton = document.querySelector('.view');
        const guideText = document.querySelector('.frame'); // å¼•å¯¼æ–‡æœ¬
        const weatherInfo = document.querySelector('.frame-3'); // å¤©æ°”ä¿¡æ¯
        const inputArea = document.querySelector('.frame-6'); // è¾“å…¥åŒºåŸŸ
        let mediaRecorder = null;
        let audioChunks = [];
        
        // æ–‡æœ¬è¾“å…¥å¤„ç†
        inputField.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const mood = inputField.value.trim();
                if (mood) {
                    // å…ˆéšè—å¼•å¯¼æ–‡æœ¬
                    hideGuideText();
                    // ç„¶åç”Ÿæˆè¯—æ­Œ
                    await generatePoetryAndStartGame(mood);
                }
            }
        });

        // è¯­éŸ³æŒ‰é’®å¤„ç†
        voiceButton.addEventListener('click', async () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // åœæ­¢å½•éŸ³
                mediaRecorder.stop();
                voiceButton.style.backgroundColor = '#000000';
            } else {
                // å¼€å§‹å½•éŸ³
                await startRecording();
                voiceButton.style.backgroundColor = '#ff4444';
            }
        });

        // éšè—å¼•å¯¼æ–‡æœ¬
        function hideGuideText() {
            if (guideText) {
                guideText.classList.add('guide-text-fade-out');
            }
        }

        // ç”Ÿæˆè¯—æ­Œå¹¶å¼€å§‹æ¸¸æˆ
        async function generatePoetryAndStartGame(mood) {
            try {
                console.log('æ­£åœ¨ç”Ÿæˆè¯—æ­Œ...', mood);
                
                const response = await fetch('/api/generate-poetry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mood })
                });

                const data = await response.json();
                
                if (data.success) {
                    console.log('è¯—æ­Œç”ŸæˆæˆåŠŸ:', data.poetry);
                    
                    // æ˜¾ç¤ºè¯—æ­Œ
                    showPoetry(data.poetry);
                    
                    // ç¡®ä¿è¯—æ­Œå®Œå…¨æ˜¾ç¤ºåå†ç”Ÿæˆå›¾ç‰‡
                    setTimeout(() => {
                        console.log('å¼€å§‹ç”Ÿæˆå›¾ç‰‡ï¼Œè¯—æ­Œå†…å®¹:', data.poetry);
                        generateImageFromPoetry(data.poetry);
                    }, 3000); // å¢åŠ åˆ°3ç§’ï¼Œç¡®ä¿è¯—æ­Œå®Œå…¨æ˜¾ç¤º
                } else {
                    console.error('ç”Ÿæˆè¯—æ­Œå¤±è´¥:', data.error);
                    alert('ç”Ÿæˆè¯—æ­Œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ ¹æ®è¯—æ­Œç”Ÿæˆå›¾ç‰‡
        async function generateImageFromPoetry(poetry) {
            try {
                console.log('æ­£åœ¨æ ¹æ®è¯—æ­Œç”Ÿæˆå›¾ç‰‡...', poetry);
                console.log('è¯—æ­Œç±»å‹:', typeof poetry);
                console.log('è¯—æ­Œé•¿åº¦:', poetry ? poetry.length : 0);
                
                if (!poetry || poetry.trim() === '') {
                    console.error('è¯—æ­Œå†…å®¹ä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆå›¾ç‰‡');
                    return;
                }
                
                const requestBody = { 
                    poetry: poetry // ç¡®ä¿ä¼ é€’è¯—æ­Œå†…å®¹
                };
                console.log('å‘é€çš„è¯·æ±‚ä½“:', requestBody);
                
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('å“åº”æ•°æ®:', data);
                
                if (data.success) {
                    console.log('å›¾ç‰‡ç”ŸæˆæˆåŠŸ:', data.imageUrl);
                    console.log('ä½¿ç”¨çš„æç¤ºè¯:', data.prompt);
                    
                    // æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
                    showGeneratedImage(data.imageUrl);
                } else {
                    console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', data.error);
                    // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œé™é»˜å¤±è´¥
                }
            } catch (error) {
                console.error('å›¾ç‰‡ç”ŸæˆAPIè°ƒç”¨é”™è¯¯:', error);
                // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œé™é»˜å¤±è´¥
            }
        }

        // æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
        function showGeneratedImage(imageUrl) {
            // ç§»é™¤å·²å­˜åœ¨çš„å›¾ç‰‡
            const existingImage = document.querySelector('.generated-image');
            if (existingImage) {
                existingImage.remove();
            }

            // è·å–.overlapå®¹å™¨
            const overlapContainer = document.querySelector('.overlap');

            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const imageElement = document.createElement('div');
            imageElement.className = 'generated-image';
            imageElement.innerHTML = `
                <img src="${imageUrl}" alt="ç”Ÿæˆçš„å›¾ç‰‡" />
            `;

            // æ·»åŠ åˆ°.overlapå®¹å™¨å†…éƒ¨
            overlapContainer.appendChild(imageElement);

            // æ·»åŠ æ¸å…¥åŠ¨ç”»
            setTimeout(() => {
                imageElement.style.opacity = '1';
            }, 100);
            
            // éšè—poetry displayï¼Œè®©p5.jsæ•ˆæœç›´æ¥æ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸Š
            const poetryDisplay = document.querySelector('.poetry-display');
            if (poetryDisplay) {
                poetryDisplay.style.display = 'none';
            }

            // å›¾ç‰‡æ˜¾ç¤ºååœæ­¢p5.jsä¸‹æ–°è¯ï¼Œåªä¿ç•™å·²å›ºå®šçš„è¯
            setTimeout(() => {
                if (window.stopFallingWords) {
                    window.stopFallingWords();
                }
            }, 1000); // å›¾ç‰‡æ˜¾ç¤º1ç§’ååœæ­¢ä¸‹æ–°è¯
        }

        // æ˜¾ç¤ºè¯—æ­Œ
        function showPoetry(poetry) {
            // ç§»é™¤å·²å­˜åœ¨çš„è¯—æ­Œæ˜¾ç¤º
            const existingPoetry = document.querySelector('.poetry-display');
            if (existingPoetry) {
                existingPoetry.remove();
            }

            // è·å–.overlapå®¹å™¨ï¼ˆiPhoneå±å¹•æ¡†æ¶å†…ï¼‰
            const overlapContainer = document.querySelector('.overlap');

            // åˆ›å»ºè¯—æ­Œæ˜¾ç¤ºå…ƒç´ ï¼Œä½†å…ˆéšè—
            const poetryDisplay = document.createElement('div');
            poetryDisplay.className = 'poetry-display';
            poetryDisplay.style.display = 'none'; // å…ˆéšè—
            poetryDisplay.innerHTML = `
                <div class="poetry-text">${poetry}</div>
            `;

            // æ·»åŠ åˆ°.overlapå®¹å™¨å†…éƒ¨ï¼Œç¡®ä¿åœ¨iPhoneå±å¹•æ¡†æ¶å†…
            overlapContainer.appendChild(poetryDisplay);

            // ä¿å­˜è¯—æ­Œå†…å®¹ä¾›åç»­ä½¿ç”¨
            window.currentPoetry = poetry;
            
            // ç«‹å³å¯åŠ¨p5.jsè¯—æ­Œè½ä¸‹æ•ˆæœ
            setTimeout(() => {
                if (window.startFallingWords) {
                    window.startFallingWords(poetry);
                }
            }, 500); // 0.5ç§’åå¼€å§‹è½ä¸‹æ•ˆæœ
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await sendAudioToServer(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                console.log('å¼€å§‹å½•éŸ³...');
            } catch (error) {
                console.error('å½•éŸ³å¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }

        // å‘é€éŸ³é¢‘åˆ°æœåŠ¡å™¨
        async function sendAudioToServer(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');

                const response = await fetch('/api/speech-to-text', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    console.log('è¯­éŸ³è¯†åˆ«æˆåŠŸ:', data.text);
                    inputField.value = data.text;
                    // éšè—å¼•å¯¼æ–‡æœ¬
                    hideGuideText();
                    // è‡ªåŠ¨ç”Ÿæˆè¯—æ­Œ
                    await generatePoetryAndStartGame(data.text);
                } else {
                    console.error('è¯­éŸ³è¯†åˆ«å¤±è´¥:', data.error);
                    alert('è¯­éŸ³è¯†åˆ«å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('å‘é€éŸ³é¢‘å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
    </script>
  </body>
</html> 